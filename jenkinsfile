pipeline {
    agent any 

    stages {

        stage('build the app') { 
            when {
                anyOf {
                    branch '*'
                }
            }  
            steps {
                script {             
                    sh 'docker-compose up -d '      
                }
            }
        }

        stage('e2e tests'){
            when {
                anyOf {
                    branch '*'
                }
            }
            steps{
                script{
                        sh """
                            counter=0
                            while [ "\$counter" -le 20 ]; do
                            check=`curl -LI hometask-nginx:80 --connect-timeout 5 -o /dev/null -w '%{http_code}\n' -s || true`
                            if [ \$check -eq "200" ]; then 
                                echo "e2e finished successfully"
                                docker-compose down 
                                exit 0
                            else 
                                echo \$check
                                sleep 3
                                counter=\$((counter+1))
                            fi
                            done
                            echo "e2e timeout -- failed"
                            exit 1
                        """ 
                }                          
            }
        }

        stage("publish to ecr"){
            when {
                anyOf {
                    branch 'main'
                }
            }
            steps{
                script{
                    withAWS(credentials:'AWS_Cred_Private', region: 'us-west-1') {
                        //Calculate the future tag if exist tags in ecr else use the default first tag 1.0.0   
                        tag = sh (script: "aws ecr list-images --repository-name Hometask --filter --region us-west-1 tagStatus=TAGGED | grep imageTag | awk ' { print \$2 } ' |sort -V -r | head -1 | sed 's/\"//g' |tr \".\" \" \" | awk ' { print \$1 \".\" \$2 \".\" \$3+1 } '", returnStdout: true).trim()               
                        docker.withRegistry('https://644435390668.dkr.ecr.us-west-1.amazonaws.com', 'ecr:us-west-1:AWS_Cred_Private') {
                            if (tag != ""){
                                app = docker.build("Hometask")
                                app.push("${tag}")
                            }
                            else{
                                app = docker.build("Hometask")
                                app.push("1.0.0")
                            }                      
                        }
                    }
                }
            } 
        } 
          
        stage('tag new version'){
            when {
                anyOf {
                    branch 'main'
                }
            }
            steps{
                script{    
                    withAWS(credentials:'AWS_Cred_Private', region: 'us-west-1') {  
                        tag = sh (script: "aws ecr list-images --repository-name hometask --filter --region us-west-1 tagStatus=TAGGED | grep imageTag | awk ' { print \$2 } ' |sort -V -r | head -1 | sed 's/\"//g'", returnStdout: true).trim()
                        withCredentials([[$class: 'UsernamePasswordMultiBinding' , credentialsId: 'portfolio-github-cred', usernameVariable: 'username', passwordVariable: 'password']]){	
                            sh """
                                git clean -f -x
                                git tag -a ${tag} -m "version ${tag}"
                                git push https://$username:$password@github.com/Brylov/HomeTask.git --tag                          
                            """
                        } 
                    }                   
                }
            }
        }
        // stage('helm chart update'){         
        //     steps{
        //         script{
        //             withAWS(credentials:'AWS_Cred', region: 'us-west-1') {      
        //                 tag = sh (script: "aws ecr list-images --repository-name hometask --filter --region us-west-1 tagStatus=TAGGED | grep imageTag | awk ' { print \$2 } ' |sort -V -r | head -1 | sed 's/\"//g'", returnStdout: true).trim()
        //                 withCredentials([[$class: 'UsernamePasswordMultiBinding' , credentialsId: 'hometask-github-cred', usernameVariable: 'username', passwordVariable: 'password']]){
        //                     git url:"https://github.com/Brylov/ToDo-List-app-helm-chart", branch: "main", credentialsId: 'portfolio-github-cred' 
        //                     sh """yq -i '.flaskapp.image.tag = "${tag}"' helm/prod-values.yaml"""
        //                     sh """yq -i '.nginx.image.tag = "${tag}"' helm/prod-values.yaml"""
        //                     sh """
        //                             git add .
        //                             git commit -m "image update version -- new version -- ${tag} #jenkins"
        //                             git push https://$username:$password@github.com/Brylov/ToDo-List-app-helm-chart                          
        //                     """
        //                 }
                        
        //             }
        //         }
        //     }
        // }
    }
    post { 
        always { 
            cleanWs()
        }
    }
}